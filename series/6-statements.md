TrÃ¬nh thÃ´ng dá»‹ch mÃ  chÃºng ta Ä‘Ã£ cÃ¹ng táº¡o ra á»Ÿ bÃ i trÆ°á»›c trÃ´ng khÃ´ng giá»‘ng viá»‡c láº­p trÃ¬nh láº¯m mÃ  giá»‘ng nhÆ° má»™t cÃ¡i mÃ¡y tÃ­nh cÆ¡ báº£n Ä‘Æ°a phÃ©p tÃ­nh vÃ o vÃ  nÃ³ tráº£ ra káº¿t quáº£. Láº­p trÃ¬nh theo mÃ¬nh lÃ  xÃ¢y dá»±ng cáº£ má»™t cáº¥u trÃºc dá»±a trÃªn cÃ¡c thÃ nh pháº§n nhá». ChÃºng ta hiá»‡n khÃ´ng thá»ƒ lÃ m Ä‘iá»u Ä‘Ã³ vÃ¬ khÃ´ng cÃ³ cÃ¡ch nÃ o Ä‘á»ƒ gÃ¡n má»™t cÃ¡i tÃªn báº¥t kÃ¬ cho biáº¿n hay hÃ m nÃ o Ä‘Ã³. ChÃºng ta khÃ´ng thá»ƒ táº¡o nÃªn chÆ°Æ¡ng trÃ¬nh hoÃ n chá»‰nh náº¿u khÃ´ng cÃ³ cÃ¡ch nÃ o Ä‘á»ƒ tham chiáº¿u giÃ¡ trá»‹ qua tÃªn biáº¿n hay tÃªn hÃ m.

Äá»ƒ thá»±c hiá»‡n Ä‘iá»u nÃ y, trÃ¬nh thÃ´ng dá»‹ch pháº£i cÃ³ cÆ¡ cháº¿ lÆ°u láº¡i tráº¡ng thÃ¡i ná»™i bá»™ cá»§a nÃ³, má»¥c tiÃªu cá»§a bÃ i viáº¿t nÃ y khÃ´ng chá»‰ khiáº¿n nÃ³ thá»±c hiá»‡n lá»‡nh Ä‘Æ°á»£c mÃ  cÃ²n cÃ³ thá»ƒ *ghi nhá»›*.

![image.png](https://images.viblo.asia/e1556974-5ca8-4429-86c4-b6a1276c05a5.png)

Trong bÃ i viáº¿t nÃ y chÃºng ta sáº½ lÃ m Ä‘iá»u Ä‘Ã³. Äá»‹nh nghÄ©a cÃ¢u lá»‡nh xuáº¥t ra mÃ n hÃ¬nh `in` vÃ  cÃ¢u lá»‡nh khai bÃ¡o biáº¿n `táº¡o`.ChÃºng ta sáº½ thÃªm cÃ¡c biá»ƒu thá»©c Ä‘á»ƒ truy cáº­p vÃ  gÃ¡n cho cÃ¡c biáº¿n. Cuá»‘i cÃ¹ng chÃºng ta sáº½ triá»ƒn khai tráº¡ng thÃ¡i trong pháº¡m vi cá»¥c bá»™.

# CÃ¢u lá»‡nh (statements)
ChÃºng ta sáº½ má»Ÿ rá»™ng bá»™ quy táº¯c cá»§a ViL vá»›i má»™t loáº¡i quy táº¯c má»›i - statements, chÃºng khÃ´ng khÃ¡c biá»‡t quÃ¡ nhiá»u vá»›i expression. Báº¯t Ä‘áº§u vá»›i 2 loáº¡i statements:
- CÃ¢u lá»‡nh biá»ƒu thá»©c ***expression statements***: Váº«n lÃ  má»™t biá»ƒu thá»©c chung nhÆ°ng ta ngÄƒn cÃ¡ch nÃ³ báº±ng dáº¥u `;` á»Ÿ cuá»‘i, trÃ¡nh cÃ¡c side-effect giá»¯a 2 biá»ƒu thá»©c khÃ¡c nhau nhÆ°ng Ä‘áº·t cáº¡nh nhau gÃ¢y hiá»ƒu láº§m. Báº¡n cÃ³ thá»ƒ khÃ´ng nháº­n tháº¥y chÃºng, nhÆ°ng báº¡n váº«n sá»­ dá»¥ng chÃºng má»i lÃºc trong C, Java vÃ  cÃ¡c ngÃ´n ngá»¯ khÃ¡c. Báº¥t cá»© khi nÃ o báº¡n tháº¥y má»™t hÃ m hoáº·c lá»‡nh gá»i phÆ°Æ¡ng thá»©c Ä‘Æ°á»£c theo sau bá»Ÿi dáº¥u `;`, báº¡n Ä‘ang khai bÃ¡o má»™t cÃ¢u lá»‡nh biá»ƒu thá»©c.
- CÃ¢u lá»‡nh xuáº¥t ra mÃ n hÃ¬nh ***print statements***: Ä‘Ã¡nh giÃ¡ má»™t biá»ƒu thá»©c vÃ  hiá»ƒn thá»‹ káº¿t quáº£ ra mÃ n hÃ¬nh cho ngÆ°á»i dÃ¹ng. hÆ¡i kÃ¬ láº¡ khi Ä‘á»ƒ phÆ°Æ¡ng thá»©c in lÃ  má»™t cÃ¢u lá»‡nh riÃªng thay vÃ¬ má»™t hÃ m gá»i, tuy nhiÃªn Ä‘á»ƒ thá»±c hiá»‡n chá»©c nÄƒng hÃ m cho ngÃ´n ngá»¯ chÃºng ta cáº§n ráº¥t nhiá»u thá»© Ä‘á»ƒ triá»ƒn khai mÃ  mÃ¬nh sáº½ Ä‘Ã¡nh Ä‘á»•i Ä‘iá»u Ä‘Ã³ Ä‘á»ƒ chÃºng ta cÃ³ thá»© gÃ¬ Ä‘Ã³ Ä‘á»ƒ nghá»‹ch ngá»£m vá»›i ViL trong lÃºc nÃ³ chÆ°a hoÃ n thiá»‡n.

Má»™t quy táº¯c má»›i Ä‘Æ°á»£c thÃªm vÃ o váº­y nÃªn chÃºng ta cÃ³ má»™t báº£ng quy táº¯c má»›i, vá»›i viá»‡c thÃªm statement cuá»‘i cÃ¹ng ta Ä‘Ã£ phÃ¢n tÃ­ch toÃ n bá»™ mÃ£ cá»§a ViL chá»© khÃ´ng chá»‰ má»™t biá»ƒu thá»©c Ä‘Æ¡n giáº£n. Bá»™ quy táº¯c má»›i nhÆ° sau:
```js
program               => statement* EOF ;

statement             => expressionStatement
                      | printStatement ;

expressionStatement   => expression ";" ;
printStatement        => "xuáº¥t" expression ";" ;
```

Quy táº¯c má»›i Ä‘áº§u tiÃªn `program` Ä‘áº¡i diá»‡n cho cáº£ chÆ°Æ¡ng trÃ¬nh vá»›i táº­p há»£p cÃ¡c cÃ¢u lá»‡nh liÃªn tiáº¿p vÃ  káº¿t thÃºc khi chÃºng ta Ä‘áº¿n cuá»‘i file. Hiá»‡n táº¡i chÃºng ta cÃ³ hai loáº¡i cÃ¢u lá»‡nh nhÆ° Ä‘Ã£ nÃ³i bÃªn trÃªn, bÃ¢y giá» bÆ°á»›c tiáº¿p theo lÃ  chuyá»ƒn tá»« cÃ¡c quy táº¯c sang cÃ¢y cÃº phÃ¡p vÃ  thá»±c thi nÃ³.


## CÃ¢y cÃº phÃ¡p cá»§a cÃ¢u lá»‡nh
* ChÃºng ta khÃ´ng thá»ƒ sá»­ dá»¥ng láº¡i lá»›p Ä‘áº¡i diá»‡n cÃ¢y cÃº phÃ¡p cá»§a biá»ƒu thá»©c (expresssion) Ä‘á»ƒ biá»ƒu diá»…n cÃ¢u lá»‡nh, nhÆ° trong báº£ng quy táº¯c phÃ©p cá»™ng cÃ¢u lá»‡nh hay trá»« lÃ  vÃ´ lÃ­. Äiá»u Ä‘Ã³ dáº«n dáº¿n viá»‡c ta cáº§n pháº£i táº¡o má»™t base class má»›i cho cÃ¢u lá»‡nh. NhÆ°ng Ä‘á»«ng lo, nÃ³ khÃ´ng khÃ¡c biá»ƒu thá»©c lÃ  máº¥y, ta chá»‰ cáº§n Ä‘á»‹nh nghÄ©a cÃº phÃ¡p vÃ  pháº§n code sáº½ do code gen Ä‘áº£m nhiá»‡m.

Source: `lib/grammar/statement.dart`
```dart
import 'package:annotations/annotations.dart';
import 'package:vil/grammar/expression.dart';

part 'statement.g.dart';

@Ast([
  'PrintStmt : Expression expression',
  'ExprStmt  : Expression expression',
])
class _Statement {}
```

VÃ  cháº¡y lá»‡nh `dart run build_runner build`, káº¿t quáº£ ta gen Ä‘Æ°á»£c file `statement.g.dart` nhÆ° sau:
```dart
// GENERATED CODE - DO NOT MODIFY BY HAND

part of 'statement.dart';

// **************************************************************************
// AstGenerator
// **************************************************************************

abstract class StatementVisitor<T> {
  T visitPrintStmt(PrintStmt printStmt);
  T visitExprStmt(ExprStmt exprStmt);
}

abstract class Statement {
  T accept<T>(StatementVisitor<T> visitor);
}

class PrintStmt extends Statement {
  final Expression expression;
  PrintStmt(
    this.expression,
  );
  T accept<T>(StatementVisitor<T> visitor) {
    return visitor.visitPrintStmt(this);
  }
}

class ExprStmt extends Statement {
  final Expression expression;
  ExprStmt(
    this.expression,
  );
  T accept<T>(StatementVisitor<T> visitor) {
    return visitor.visitExprStmt(this);
  }
}
```

## PhÃ¢n tÃ­ch cÃ¢u lá»‡nh
HÃ m `parse` trong lá»›p Parser giá» Ä‘Ã¢y sáº½ khÃ´ng cÃ²n tráº£ vá» `Expression` ná»¯a mÃ  lÃ  má»™t loáº¡t cÃ¡c `Statement`:

Source: `lib/parser.dart`, Sá»­a Ä‘á»•i hÃ m `parse`
```dart
List<Statement>? parse() {
  try {
    List<Statement> statements = [];
    while (!_isAtEnd) {
      statements.add(_statement());
    }

    return statements;
  } on ParserError catch (_) {
    return null;
  }
}
```

Äá»«ng quÃªn import `Statement` nhÃ©:

```dart
import 'package:vil/grammar/statement.dart';
```

HÃ m `parse` khÃ¡ dá»… dÃ ng chuyá»ƒn tá»« bá»™ quy táº¯c `program` sang. Thu tháº­p táº¥t cáº£ cÃ¡c cÃ¢u lá»‡nh cho Ä‘áº¿n khi Ä‘áº¿n cuá»‘i file.

### CÃ¢u lá»‡nh chung
HÃ m `_statement` giá»‘ng nhÆ° hÃ m `_expression` nÃ³ "gÃ³i" chung láº¡i táº¥t cáº£ cÃ¡c cÃ¢u lá»‡nh tuy nhiÃªn hÆ¡i khÃ¡c má»™t chÃºt cÃ¡c cÃ¢u lá»‡nh cÃ³ má»©c Ä‘á»™ Æ°u tiÃªn ngang báº±ng nhau nÃªn chÃºng cÃ¹ng xuáº¥t hiá»‡n á»Ÿ trong hÃ m `_statement` cÃ²n biá»ƒu thá»©c pháº£i cÃ³ sá»± Æ°u tiÃªn trÆ°á»›c sau nÃªn nÃ³ chá»‰ gÃ³i láº¡i biá»ƒu thá»©c má»©c Ä‘á»™ Æ°u tiÃªn tháº¥p nháº¥t.

Source: `lib/parser.dart`
```dart
Statement _statement() {
  if (_match([TokenType.kXuat])) {
    return _printStatement();
  }

  return _expressionStatement();
}
```

### CÃ¢u lá»‡nh xuáº¥t
HÃ m táº¡o cÃ¢u lá»‡nh xuáº¥t ra mÃ n hÃ¬nh cá»© Ã¡p dá»¥ng cÃ´ng thá»©c mÃ  lÃ m lÃ  xong :D
```dart
Statement _printStatement() {
  final expression = _expression();
  _consume(
      TokenType.semicolon, 'Thiáº¿u dáº¥u ";" sau cÃ¢u lá»‡nh xuáº¥t ra mÃ n hÃ¬nh.');

  return Print(expression);
}
```

### CÃ¢u lá»‡nh biá»ƒu thá»©c
NhÆ° cÃ´ng thá»©c ğŸ˜‰

```dart
Statement _expressionStatement() {
  final expression = _expression();
  _consume(TokenType.semicolon, 'Thiáº¿u dáº¥u ";" sau cÃ¢u lá»‡nh.');

  return Expr(expression);
}
```

## Thá»±c thi cÃ¢u lá»‡nh
TrÃ¬nh phÃ¢n tÃ­ch cÃº phÃ¡p cá»§a chÃºng ta hiá»‡n cÃ³ thá»ƒ táº¡o ra cÃ¡c cÃ¢y cÃº phÃ¡p cÃ¢u lá»‡nh, vÃ¬ váº­y bÆ°á»›c tiáº¿p theo vÃ  cuá»‘i cÃ¹ng lÃ  diá»…n giáº£i chÃºng. Giá»‘ng nhÆ° trong cÃ¡c biá»ƒu thá»©c, chÃºng ta sá»­ dá»¥ng visitor patterm, vÃ  vá»›i má»™t base class má»›i ta cÅ©ng pháº£i cÃ³ má»™t Visitor riÃªng cá»§a nÃ³ `StatementVisitor` Ä‘á»ƒ thá»±c thi.

Source: `lib/interpreter.dart`
```dart
class Interpreter
    implements ExpressionVisitor<dynamic>, StatementVisitor<void> {
...


  @override
  void visitExpr(Expr exprStmt) {
    // TODO: implement visitExpr
  }

  @override
  void visitPrint(Print printStmt) {
    // TODO: implement visitPrint
  }
}
```

CÃ¢u lá»‡nh khÃ´ng tráº£ vá» gÃ¬ cáº£ mÃ  nÃ³ chá»‰ thá»±c thi nÃªn generic type cá»§a nÃ³ lÃ  void.

### Thá»±c thi cÃ¢u lá»‡nh xuáº¥t
Vá» cÃ¢u lá»‡nh xuáº¥t ra mÃ n hÃ¬nh chá»‰ Ä‘Æ¡n giáº£n lÃ  Ä‘Ã¡nh giÃ¡ biá»ƒu thá»©c bÃªn trong vÃ  qua hÃ m `print` cá»§a dart xuáº¥t ra mÃ n hÃ¬nh, váº­y lÃ  hoÃ n thÃ nh. Ä‘á»ƒ cháº¯c cháº¯n ta Ä‘Æ°a giÃ¡ trá»‹ vÃ o hÃ m `_stringify` Ä‘á»ƒ xá»­ lÃ­ sang chuÃ´Ä© tÆ°Æ¡ng á»©ng giÃ¡ trá»‹.

```dart
@override
void visitPrint(Print printStmt) {
  final value = _evaluate(printStmt.expression);
  print(_stringify(value));
}
```

Äáº§u vÃ o cá»§a `Interpreter` Ä‘Ã£ thay Ä‘á»•i nÃ³ lÃ  má»™t `List<Statement>` thay vÃ¬ `Expression` khi trÆ°á»›c, sá»­a láº¡i hÃ m `interpret` má»™t chÃºt:

Source: `lib/interpreter.dart`
```dart
void interpret(List<Statement> statements) {
  try {
    for (final statement in statements) {
      _execute(statement);
    }
  } on RuntimeError catch (error) {
    Vil.runtimeError(error);
  }
}
```

HÃ m `_execute` truyá»n `Interpreter` vÃ o `statement` Ä‘á»ƒ tá»± Ä‘Ã¡nh giÃ¡.

Source: `lib/interpreter.dart`, bÃªn dÆ°á»›i `interpret`
```dart
void _execute(Statement statement) {
  statement.accept(this);
}
```

Sá»­a láº¡i hÃ m `run` trong lá»›p gá»‘c `Vil`.

Source: `lib/vil.dart`, hÃ m `run`
```dart
static void run(String source) {
  Scanner scanning = Scanner(source);
  List<Token> tokens = scanning.scan();

  Parser parser = Parser(tokens);
  final statements = parser.parse();
  if (statements != null) {
    interpreter.interpret(statements);
  }
}
```

Tuyá»‡t! ChÃºng ta Ä‘Ã£ cÃ³ kháº£ nÄƒng thá»±c hiá»‡n Ä‘Æ°á»£c lá»‡nh xuáº¥t ra mÃ n hÃ¬nh.
```js
.../crafting-interpreters/vil/vil$ dart run lib/vil.dart
lib/vil.dart: Warning: Interpreting this as package URI, 'package:vil/vil.dart'.
> xuáº¥t "ChÃ o tháº¿ giá»›i";
ChÃ o tháº¿ giá»›i
> xuáº¥t 3 * 4 + 5; 
17
> xuáº¥t Ä‘Ãºng;
Ä‘Ãºng
> xuáº¥t rá»—ng;
rá»—ng
```

NÃ³ gáº§n giá»‘ng nhÆ° má»™t chÆ°Æ¡ng trÃ¬nh thá»±c sá»±! Äá»«ng quÃªn dáº¥u `;` cá»§a báº¡n nhÃ© ğŸ˜…

# Biáº¿n toÃ n cá»¥c
BÃ¢y giá» chÃºng ta Ä‘Ã£ cÃ³ cÃ¡c cÃ¢u lá»‡nh, chÃºng ta cÃ³ thá»ƒ báº¯t Ä‘áº§u lÃ m viá»‡c vá» tráº¡ng thÃ¡i cá»§a chÆ°Æ¡ng trÃ¬nh. TrÆ°á»›c khi Ä‘i vÃ o táº¥t cáº£ sá»± phá»©c táº¡p vá» tráº¡ng thÃ¡i cá»¥c bá»™, chÃºng ta hÃ£y báº¯t Ä‘áº§u vá»›i loáº¡i lÆ°u biáº¿n Ä‘Æ¡n giáº£n nháº¥t - biáº¿n toÃ n cá»¥c. ChÃºng ta cáº§n hai cÃº phÃ¡p mÆ¡i Ä‘á»ƒ thá»±c hiá»‡n Ä‘iá»u nÃ y.
1. CÃº phÃ¡p **khai bÃ¡o** vÃ  **khá»Ÿi táº¡o** biáº¿n. CÃ¢u lá»‡nh nÃ y thá»±c hiá»‡n hai viá»‡c khá»Ÿi táº¡o biáº¿n tÃªn `hoa`, sau Ä‘Ã³ gÃ¡n giÃ¡ trá»‹ `"cÃºc dáº¡i"` cho nÃ³.
```dart
táº¡o hoa = "cÃºc dáº¡i";
```
2. Sau khi thá»±c hiá»‡n thÃ nh cÃ´ng cÃ¢u lá»‡nh trÃªn, truy cáº­p vÃ o tÃªn biáº¿n `hoa` láº¥y giÃ¡ trá»‹ `"cÃºc dáº¡i"` ra vÃ  xuáº¥t ra mÃ n hÃ¬nh.
```dart
xuáº¥t hoa; // cÃºc dáº¡i
```

Sau Ä‘Ã³, chÃºng tÃ´i sáº½ thÃªm phÃ©p gÃ¡n vÃ  khá»‘i lá»‡nh, nhÆ°ng hiá»‡n táº¡i nhÆ° váº­y lÃ  Ä‘á»§ Ä‘á»ƒ triá»ƒn khai.

## CÃº phÃ¡p táº¡o biáº¿n
NhÆ° bÃªn trÃªn chÃºng ta Ä‘Ã£ Ä‘á»‹nh nghÄ©a nÃ³ sáº½ cÃ³ dáº¡ng
```dart
táº¡o hoa = "cÃºc dáº¡i";
```
Quy táº¯c tÆ°Æ¡ng Ä‘Æ°Æ¡ng nhÆ° sau
```js
variableDecl => "táº¡o" IDENTIFIER ("=" expression)? ";" ;
```


Quy táº¯c má»›i cá»§a chÃºng ta nhÆ° sau:
```js
program        => statement* EOF ;

statement      => expressionStatement
               |  printStatement
               |  variableDecl ;
```

NhÆ°ng Ä‘á»ƒ thuáº­n tiá»‡n vá» viá»‡c Ä‘á»‹nh nghÄ©a cÃ¡c quy táº¯c má»›i vá» khai bÃ¡o hÃ m, khai bÃ¡o lá»›p á»Ÿ trong cÃ¡c bÃ i viáº¿t sau chÃºng ta sáº½ tÃ¡ch cÃ¢u lá»‡nh táº¡o biáº¿n ra má»™t lá»›p trá»«u tÆ°á»£ng khÃ¡c `declaration`, báº£n cháº¥t nÃ³ váº«n lÃ  `statement` nhÆ°ng vá»›i Ä‘á»™ Æ°u tiÃªn tháº¥p hÆ¡n má»™t chÃºt.

```js
program        => declaration* EOF ;

declaration    => variableDecl
               |  statement ; 

statement      => expressionStatement
               |  printStatement ;
```

ChÃºng ta cáº§n pháº£i xÃ¡c Ä‘á»‹nh Ä‘á»‹nh danh `IDENTIFIER` má»™t cÃ¡i tÃªn Ä‘áº¡i diá»‡n cho giÃ¡ trá»‹ nÃ o Ä‘Ã³, Ä‘á»ƒ truy cáº­p biáº¿n ta cÃ³ biá»ƒu thá»©c `primary` má»›i nhÆ° sau.
```dart
primary        => sá»‘ | chuá»—i
               |  "Ä‘Ãºng" | "sai" | "rá»—ng"
               |  "(" expression ")"
               |  IDENTIFIER ;
```

ChÃºng ta Ä‘Ã£ lÃ m rÃµ bá»™ quy táº¯c cáº§n thiáº¿t, bÃ¢y giá» triá»ƒn khai pháº§n code thÃ´i, Ä‘á»‹nh nghÄ©a lá»›p `VariableDeclaration` má»›i nháº­n vÃ o token `name` tÃªn cá»§a biáº¿n vÃ  `value` giÃ¡ trá»‹ khá»Ÿi táº¡o cá»§a biáº¿n Ä‘Ã³ cÃ³ thá»ƒ cÃ³ hoáº·c khÃ´ng.

Source: `lib/grammar/statement.dart`, bÃªn trÃªn `_Statement`
```dart
@Ast([
  'Print        : Expression expression',
  'Expr         : Expression expression',
  'VariableDecl : Token name, Expression? value',
])
```

ChÃºng ta cÅ©ng cáº§n thÃªm má»™t biá»ƒu thá»©c Ä‘á»ƒ lÆ°u trá»¯ tÃªn biáº¿n.

Source: `lib/grammar/expression.dart`, bÃªn trÃªn `_Expression`
```dart
@Ast([
  "Binary   : Expression left, Token operator, Expression right",
  "Grouping : Expression expression",
  "Literal  : dynamic value",
  "Unary    : Token operator, Expression right",
  "Variable : Token name"
])
```

Cháº¡y lá»‡nh `dart run build_runner build` lÃ  xong.
### PhÃ¢n tÃ­ch cÃº phÃ¡p phÃ©p táº¡o biáº¿n
BÃ¢y giá» quy táº¯c Ä‘áº§u tiÃªn lÃ  `_declaration` nÃªn chÃºng ta cáº§n chá»‰nh sá»­a má»™t chÃºt á»Ÿ hÃ m `parse` trong  `Parser`

Source: `lib/parser.dart`, hÃ m `parse`
```dart
List<Statement>? parse() {
  try {
    List<Statement> statements = [];
    while (!_isAtEnd) {
      statements.add(_declaration()); // Thay Ä‘á»•i tá»« `_statement` => `_declaration`
    }

    return statements;
  } on ParserError catch (_) {
    return null;
  }
}
```

ChÃºng ta cÃ³ má»™t hÃ m má»›i nhÆ° sau:
```dart
Statement _declaration() {
  if (_match([TokenType.kTao])) {
    return _variableDeclaration();
  }

  return _statement();
}

Statement _variableDeclaration() {
  final token = _consume(TokenType.identifier, 'Cáº§n Ä‘á»‹nh nghÄ©a tÃªn biáº¿n.');

  Expression? initializer;
  if (_match([TokenType.equal])) {
    initializer = _expression();
  }

  _consume(TokenType.semicolon, 'Thiáº¿u dáº¥u ";" sau cÃ¢u lá»‡nh.');
  return VariableDecl(token, initializer);
}
```

ThÃªm má»™t dÃ²ng Ä‘á»ƒ phÃ¢n tÃ­ch biá»ƒu thá»©c `Variable` má»›i á»Ÿ hÃ m `_primary`

```dart
Expression _primary() {
  
  ...
  
  if (_match([TokenType.identifier])) {
    return Variable(_previous());
  }

  throw _error(_peek(), 'Token chÆ°a cÃ³ trong báº£ng quy táº¯c.');
}
```

Táº¥t cáº£ viá»‡c nÃ y cung cáº¥p cho chÃºng ta pháº§n phÃ¢n tÃ­ch hoáº¡t Ä‘á»™ng Ä‘á»ƒ khai bÃ¡o vÃ  sá»­ dá»¥ng cÃ¡c biáº¿n. Táº¥t cáº£ nhá»¯ng gÃ¬ cÃ²n láº¡i lÃ  Ä‘Æ°a káº¿t quáº£ vÃ o trÃ¬nh thÃ´ng dá»‹ch. TrÆ°á»›c khi Ä‘áº¡t Ä‘Æ°á»£c Ä‘iá»u Ä‘Ã³, chÃºng ta cáº§n nÃ³i vá» nÆ¡i cÃ¡c biáº¿n "sá»‘ng" trong bá»™ nhá»›.

# MÃ´i trÆ°á»ng lÆ°u trá»¯
CÃ¡c rÃ ng buá»™c liÃªn káº¿t cÃ¡c biáº¿n vá»›i giÃ¡ trá»‹ cáº§n Ä‘Æ°á»£c lÆ°u trá»¯ á»Ÿ Ä‘Ã¢u Ä‘Ã³. Ká»ƒ tá»« khi ngÆ°á»i Lisp phÃ¡t minh ra dáº¥u ngoáº·c Ä‘Æ¡n, cáº¥u trÃºc dá»¯ liá»‡u nÃ y Ä‘Ã£ Ä‘Æ°á»£c gá»i lÃ  **mÃ´i trÆ°á»ng**.

Source: `https://craftinginterpreters.com`
![image.png](https://images.viblo.asia/e72107c2-f8d8-4029-a108-e4f37903a1b1.png)

NÃ³ cÃ³ thá»ƒ hiá»ƒu Ä‘Æ¡n giáº£n lÃ  má»™t `Map` vá»›i key lÃ  tÃªn Ä‘á»‹nh danh cá»§a biáº¿n Ä‘Ã³ vÃ  value lÃ  giÃ¡ trá»‹ cá»§a nÃ³, chÃºng ta cÃ³ thá»ƒ khai bÃ¡o trá»±c tiáº¿p theo dáº¡ng map vÃ o trÃ¬nh thÃ´ng dá»‹ch nhÆ°ng vÃ¬ tÃ­nh Ä‘Ã³ng gÃ³i ta sáº½ Ä‘Æ°a nÃ³ vÃ o má»™t lá»›p má»›i `Environment` Ä‘á»ƒ tiá»‡n triá»ƒn khai.

Source: `lib/environment.dart`, táº¡o file vÃ  táº¡o lá»›p `Environment`
```dart
import 'package:vil/interpreter.dart';
import 'package:vil/token.dart';

class Environment {
  Map<String, dynamic> _values = {};
}
```

ChÃºng ta sá»­ dá»¥ng `String` thay vÃ¬ `Token` vÃ¬ `Token` vÃ¬ `Token` chá»©a cáº£ **vá»‹ trÃ­** cá»§a tÃªn biáº¿n, chÃºng ta khÃ´ng cáº§n Ä‘áº¿n Ä‘iá»u Ä‘Ã³ nÃªn thay vÃ¬ tháº¿ sá»­ dá»¥ng luÃ´n tÃªn biáº¿n Ä‘á»ƒ lÃ m key.

MÃ´i trÆ°á»ng cáº§n hai phÆ°Æ¡ng thá»©c Ä‘á»ƒ **khai bÃ¡o** vÃ  **truy cáº­p** biáº¿n nhÆ° sau.

Source: `lib/environment.dart`, phÆ°Æ¡ng thá»©c khai bÃ¡o biáº¿n (`define`)
```dart
void define(String name, dynamic value) {
  _values[name] = value;
}
```

KhÃ´ng háº³n lÃ  cá»‘ Ã½, nhÆ°ng chÃºng ta Ä‘Ã£ Ä‘Æ°a ra má»™t sá»± lá»±a chá»n trong cÃ¡ch cÃ¡ch tiáº¿p cáº­n biáº¿n. Khi ta thÃªm key vÃ o map `_values` vÃ  khÃ´ng kiá»ƒm tra xem nÃ³ Ä‘Ã£ cÃ³ sáºµn hay chÆ°a. Äiá»u Ä‘Ã³ cÃ³ nghÄ©a lÃ  chÆ°Æ¡ng trÃ¬nh nÃ y hoáº¡t Ä‘á»™ng, nÃ³ khÃ´ng phÃ¢n biá»‡t rÃµ rÃ ng biáº¿n Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi táº¡o hay chÆ°a mÃ  chá»‰ thay Ä‘á»•i giÃ¡ trá»‹ cá»§a biáº¿n.
```js
táº¡o a = "before";
xuáº¥t a; // "before".
táº¡o a = "after";
xuáº¥t a; // "after".
```


Source: `lib/environment.dart`, phÆ°Æ¡ng thá»©c truy cáº­p biáº¿n (`define`)
```dart
dynamic get(Token name) {
  if (_values.containsKey(name.lexeme)) {
    return _values[name.lexeme];
  }
  
  throw RuntimeError(
    token: name,
    message: 'Biáº¿n "${name.lexeme}" chÆ°a Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a.',
  );
}
```

Khi truy cáº­p náº¿u khÃ´ng tá»“n táº¡i chÃºng ta nÃ©m tráº£ láº¡i má»™t lá»—i runtime.

## Triá»ƒn khai biáº¿n toÃ n cá»¥c
Táº¡o má»™t instance cá»§a `Environment` trong lá»›p `Interpreter`

Source: `lib/interpreter.dart`
```dart
class Interpreter
    implements ExpressionVisitor<dynamic>, StatementVisitor<void> {
  Environment _environment = Environment();

  ...
}
```

ChÃºng ta lÆ°u trá»¯ biáº¿n trong mÃ´i trÆ°á»ng Ä‘áº¿n khi nÃ o mÃ  `Interpreter` váº«n tá»“n táº¡i vÃ  Ä‘ang cháº¡y. 

á» bÃªn trÃªn chÃºng ta Ä‘á»‹nh nghÄ©a hai cÃº phÃ¡p má»›i: biá»ƒu thá»©c `Variable` vÃ  cÃ¢u lá»‡nh `VariableDecl`, bÃ¢y giá» hÃ£y xá»­ lÃ­ nÃ³.

Source: `lib/interpreter.dart`, hÃ m xá»­ lÃ­ `visitVariableDecl`
```dart
@override
void visitVariableDecl(VariableDecl variableDeclStmt) {
  dynamic value = null;
  if (variableDeclStmt.value != null) {
    value = _evaluate(variableDeclStmt.value!);
  }
  _environment.define(variableDeclStmt.name.lexeme, value);
}
```

Source: `lib/interpreter.dart`, hÃ m xá»­ lÃ­ `visitVariable`
```dart
@override
dynamic visitVariable(Variable variable) {
  return _environment.get(variable.name);
}
```

BÃ¢y giá» chÃºng ta hoÃ n toÃ n cÃ³ thá»ƒ cháº¡y cÃ¢u lá»‡nh sau
```js
táº¡o a = 1;
táº¡o b = 2;
xuáº¥t a + b;
```

Vá»›i má»™t chÃºt code vá» pháº§n `Environment` ngÃ´n ngá»¯ chÃºng ta Ä‘Ã£ cÃ³ thá»ƒ **nhá»›** Ä‘Æ°á»£c dá»¯ liá»‡u.

# PhÃ©p gÃ¡n
ChÃºng ta Ä‘Ã£ cÃ³ thá»ƒ táº¡o Ä‘Æ°á»£c biáº¿n, Ä‘iá»u tiáº¿p theo lÃ  thay Ä‘á»•i biáº¿n Ä‘Ã³ theo Ã½ muá»‘n cá»§a mÃ¬nh. cÃº phÃ¡p má»›i cá»§a chÃºng ta nhÆ° sau.

```js
expression => assignment ;
assignment => IDENTIFIER "=" expression ";"
           |  equality ;
```

Quy trÃ¬nh thÃªm má»™t cÃº phÃ¡p má»›i ráº¥t Ä‘Æ¡n giáº£n nhÆ° má»i láº§n trÆ°á»›c.

Source: `lib/grammar/expression.dart`
```dart
@Ast([
  "Binary   : Expression left, Token operator, Expression right",
  "Grouping : Expression expression",
  "Literal  : dynamic value",
  "Unary    : Token operator, Expression right",
  "Variable : Token name",
  "Assign   : Token name, Expression value" // ThÃªm dÃ²ng nÃ y
])
```

## CÃº phÃ¡p phÃ©p gÃ¡n
Tiáº¿p tá»¥c thay Ä‘á»•i `Parser` theo quy táº¯c má»›i.

Source: `lib/parser.dart`
```dart
Expression _expression() {
  return _assignment();
}
```

Source: `lib/parser.dart`, hÃ m `_assignment` 
```dart
Expression _assignment() {
  final expression = _equality();

  if (_match([TokenType.equal])) {
    final equals = _previous();
    final value = _assignment();

    if (expression is Variable) {
      return Assign(expression.name, value);
    }

    _error(equals, 'KhÃ´ng thá»ƒ gÃ¡n giÃ¡ trá»‹ náº¿u khÃ´ng Ä‘Ã³ khÃ´ng lÃ  biáº¿n.');
  }

  return expression;
}
```

## Thá»±c thi phÃ©p gÃ¡n

Triá»ƒn khai visitor cho phÃ©p gÃ¡n trong `Interpreter`.

Source: `lib/interpreter.dart`, hÃ m `visitAssign`
```dart
@override
dynamic visitAssign(Assign assign) {
  final value = _evaluate(assign.value);
  _environment.assign(assign.name, value);
  return value;
}
```

ThÃªm phÆ°Æ¡ng thá»©c gÃ¡n trong `Environment`

Source: `lib/environment.dart`
```dart
void assign(Token name, dynamic value) {
  if (_values.containsKey(name.lexeme)) {
    _values[name.lexeme] = value;
    return;
  }

  throw RuntimeError(
    token: name,
    message: 'Biáº¿n "${name.lexeme}" chÆ°a Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a.',
  );
}
```

Xong !!! ChÃºng ta Ä‘Ã£ hoÃ n thÃ nh phÃ©p gÃ¡n cho biáº¿n toÃ n cá»¥c, pháº§n tiáº¿p theo cÃ¹ng thá»±c hiá»‡n pháº¡m vi háº¹p hÆ¡n cá»§a biáº¿n khi nÃ³ á»Ÿ trong má»™t scope nhá» hÆ¡n nhÆ° á»Ÿ trong hÃ m hay má»™t cÃ¢u lá»‡nh Ä‘iá»u kiá»‡n.

# Pháº¡m vi
**Pháº¡m vi** xÃ¡c Ä‘á»‹nh má»™t khu vá»±c nÆ¡i tÃªn Ã¡nh xáº¡ tá»›i má»™t giÃ¡ trá»‹ nháº¥t Ä‘á»‹nh. Nhiá»u pháº¡m vi cho phÃ©p **cÃ¹ng má»™t tÃªn** Ä‘á»ƒ chá»‰ nhá»¯ng thá»© khÃ¡c nhau trong cÃ¡c **ngá»¯ cáº£nh khÃ¡c nhau**. VÃ­ dá»¥ nhÆ°:
```js
{
  táº¡o a = "first";
  xuáº¥t a; // "first".
}

{
  táº¡o a = "second";
  xuáº¥t a; // "second".
}
```

Äoáº¡n code trÃªn chá»©a hai khá»‘i code khÃ¡c nhau cÃ¹ng Ä‘á»‹nh nghÄ©a biáº¿n `a` nhÆ°ng Ã¡nh xáº¡ Ä‘áº¿n cÃ¡c giÃ¡ trá»‹ khÃ¡c nhau.

![image.png](https://images.viblo.asia/4466f6b1-a77b-4f9d-9959-964aa6daf3e8.png)

Biáº¿n Ä‘Æ°á»£c táº¡o chá»‰ truy cáº­p Ä‘Æ°á»£c trong pháº¡m vi cá»§a nÃ³. sau khi ra khá»i scope, biáº¿n sáº½ Ä‘Æ°á»£c giáº£i phÃ³ng bá»™ nhá»›.
```dart
{
  táº¡o a = "in block";
}
xuáº¥t a; // Lá»—i biáº¿n a Ä‘Ã£ bá»‹ há»§y.
```

## Sá»± lá»“ng nhau cá»§a khá»‘i lá»‡nh

Sáº½ tháº¿ nÃ o náº¿u ta gá»i hÃ m xuáº¥t trong má»™t khá»‘i riÃªng nhÆ° tháº¿ nÃ y?
```js
táº¡o globalScope = "BÃªn ngoÃ i";

{
  táº¡o local = "BÃªn trong";
  {
      xuáº¥t global + local;
  }
}
```

ViL tÃ¬m kiáº¿m hai biáº¿n `globalScope` vÃ  `localScope` trong scope hiá»‡n táº¡i nhÆ°ng khÃ´ng cÃ³, tiáº¿p theo nÃ³ sáº½ tÃ¬m kiáº¿m á»Ÿ pháº¡m vi rá»™ng hÆ¡n, scope bao ngoÃ i nÃ³. A !!! tÃ¬m tháº¥y biáº¿n `localScope` rá»“i, láº¥y giÃ¡ trá»‹ cá»§a nÃ³ vÃ  tiáº¿p tá»¥c tÃ¬m biáº¿n `globalScope` nhÆ°ng trong scope nÃ y váº«n khÃ´ng cÃ³, tiáº¿p tá»¥c tÃ¬m rá»™ng ra scope lá»›n hÆ¡n ta tháº¥y `globalScope` Ä‘Ã£ Ä‘Æ°á»£c khai bÃ¡o láº¥y giÃ¡ trá»‹ vÃ  xuáº¥t phÃ©p cá»™ng chuá»—i ra mÃ n hÃ¬nh.

Äá»ƒ thá»±c hiá»‡n Ä‘Æ°á»£c hÃ nh vi nÃ y sá»­a lá»›p `Environment` thÃªm cho nÃ³ má»™t mÃ´i trÆ°á»ng "cha" bao quanh mÃ´i trÆ°á»ng hiá»‡n táº¡i.

Source: `lib/environment.dart`
```dart
class Environment {
  Environment([this.parent = null]);

  final Environment? parent;
  ...
}
```

HÃ m truy cáº­p vÃ  hÃ m gÃ¡n chÃºng ta sá»­a láº¡i kiá»ƒm tra biáº¿n cáº§n truy cáº­p hoáº·c chá»‰nh sá»­a cáº£ á»Ÿ trong mÃ´i trÆ°á»ng `parent`

Source: `lib/environment.dart`, hÃ m `get`
```dart
dynamic get(Token name) {
  if (_values.containsKey(name.lexeme)) {
    return _values[name.lexeme];
  }

  if (parent != null) return parent!.get(name);

  throw RuntimeError(
    token: name,
    message: 'Biáº¿n "${name.lexeme}" chÆ°a Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a.',
  );
}

void assign(Token name, dynamic value) {
  if (_values.containsKey(name.lexeme)) {
    _values[name.lexeme] = value;
    return;
  }
  
  if (parent != null) {
    parent!.assign(name, value);
    return;
  }

  throw RuntimeError(
    token: name,
    message: 'Biáº¿n "${name.lexeme}" chÆ°a Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a.',
  );
}
```

## CÃº phÃ¡p vÃ  thá»±c thi khá»‘i lá»‡nh
Vá»›i lá»›p `Environment` má»›i chÃºng ta hoÃ n toÃ n cÃ³ thá»ƒ triá»ƒn khai khá»‘i lá»‡nh. Quy táº¯c nhÆ° sau:
```js
statement => printStatement
          |  expressionStatement
          |  block ;

block     => "{" declaration* "}" ;
```

Khai bÃ¡o quy táº¯c má»›i vÃ  cháº¡y `dart run build_runner build`

Source: `lib/grammar/expression.dart`
```dart
@Ast([
  'Print        : Expression expression',
  'Expr         : Expression expression',
  'VariableDecl : Token name, Expression? value',
  'Block        : List<Statement> statements',
])
```

Thay Ä‘á»•i `Parser`, báº¯t cÃº phÃ¡p cá»§a khai bÃ¡o khá»‘i lá»‡nh.

Source: `lib/parser.dart`
```dart
Statement _statement() {
  if (_match([TokenType.kXuat])) {
    return _printStatement();
  }
  if (_match([TokenType.leftBrace])) {
    return _blockStatement();
  }

  return _expressionStatement();
}

Statement _blockStatement() {
  final statements = <Statement>[];

  while (!_check(TokenType.rightBrace) && !_isAtEnd) {
    statements.add(_declaration());
  }
  _consume(TokenType.rightBrace, 'Thiáº¿u dáº¥u "}" sau khá»‘i lá»‡nh.');

  return Block(statements);
}
```

Cuá»‘i cÃ¹ng lÃ  thá»±c thi khá»‘i code triá»ƒn khai visitor cá»§a khá»‘i lá»‡nh.

Source: `lib/interpreter.dart`
```dart
@override
void visitBlock(Block block) {
  Environment blockEnv = Environment(_environment);
  _environment = blockEnv;

  for (final statement in block.statements) {
    _execute(statement);
  }

  _environment = _environment.parent!;
}
```

HOÃ€N THÃ€NH!!! HÃ£y thá»­ ngay Ä‘oáº¡n code sau náº¿u báº¡n thá»±c hiá»‡n Ä‘Ãºng nhÆ° mÃ¬nh sáº½ cÃ³ káº¿t quáº£ nhÆ° bÃªn dÆ°á»›i:
```js
{
  táº¡o a = " Scope: 1 ";
  táº¡o b = " Scope: 1 ";
  táº¡o c = " Scope: 1 ";
  {
      táº¡o b = " Scope: 2 ";
      táº¡o c = " Scope: 2 ";
      {
          táº¡o a = " Scope: 3 ";
          xuáº¥t a + b + c;
      }
      xuáº¥t a + b + c;
  }
  xuáº¥t a + b + c;
}
```
Káº¿t quáº£
```dart
 Scope: 3  Scope: 2  Scope: 2 
 Scope: 1  Scope: 2  Scope: 2 
 Scope: 1  Scope: 1  Scope: 1 
```

# Tá»•ng káº¿t
BÃ i viáº¿t nÃ y chÃºng ta Ä‘Ã£ thá»±c hiÃªn Ä‘Æ°á»£c 3 thá»©:
- NgÃ´n ngá»¯ ViL Ä‘Ã£ lÆ°u trá»¯ Ä‘Æ°á»£c tráº¡ng thÃ¡i
- Táº¡o ra biáº¿n vÃ  truy cáº­p cÅ©ng nhÆ° sá»­a giÃ¡ trá»‹ cá»§a nÃ³ Ä‘Æ°á»£c
- Äá»‹nh nghÄ©a pháº¡m vi truy cáº­p cá»§a biáº¿n, tiá»n Ä‘á» Ä‘á»ƒ thá»±c hiá»‡n cÃ¡c cÃ¢u lá»‡nh Ä‘iá»u kiá»‡n vÃ  vÃ²ng láº·p, thá»© mÃ  chÃºng ta triá»ƒn khai á»Ÿ bÃ i viáº¿t sau

# MÃ£ nguá»“n
Báº¡n cÃ³ thá»ƒ theo dÃµi mÃ£ nguá»“n tá»«ng bÃ i viáº¿t táº¡i Ä‘Ã¢y. Äá»«ng ngáº¡i Ä‘á»ƒ láº¡i cho mÃ¬nh má»™t sao nhÃ© ğŸ˜

ViL : https://github.com/definev/vil