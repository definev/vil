Tr√¨nh th√¥ng d·ªãch m√† ch√∫ng ta ƒë√£ c√πng t·∫°o ra ·ªü b√†i tr∆∞·ªõc tr√¥ng kh√¥ng gi·ªëng vi·ªác l·∫≠p tr√¨nh l·∫Øm m√† gi·ªëng nh∆∞ m·ªôt c√°i m√°y t√≠nh c∆° b·∫£n ƒë∆∞a ph√©p t√≠nh v√†o v√† n√≥ tr·∫£ ra k·∫øt qu·∫£. L·∫≠p tr√¨nh theo m√¨nh l√† x√¢y d·ª±ng c·∫£ m·ªôt c·∫•u tr√∫c d·ª±a tr√™n c√°c th√†nh ph·∫ßn nh·ªè. Ch√∫ng ta hi·ªán kh√¥ng th·ªÉ l√†m ƒëi·ªÅu ƒë√≥ v√¨ kh√¥ng c√≥ c√°ch n√†o ƒë·ªÉ g√°n m·ªôt c√°i t√™n b·∫•t k√¨ cho bi·∫øn hay h√†m n√†o ƒë√≥. Ch√∫ng ta kh√¥ng th·ªÉ t·∫°o n√™n ch∆∞∆°ng tr√¨nh ho√†n ch·ªânh n·∫øu kh√¥ng c√≥ c√°ch n√†o ƒë·ªÉ tham chi·∫øu gi√° tr·ªã qua t√™n bi·∫øn hay t√™n h√†m.

ƒê·ªÉ th·ª±c hi·ªán ƒëi·ªÅu n√†y, tr√¨nh th√¥ng d·ªãch ph·∫£i c√≥ c∆° ch·∫ø l∆∞u l·∫°i tr·∫°ng th√°i n·ªôi b·ªô c·ªßa n√≥, m·ª•c ti√™u c·ªßa b√†i vi·∫øt n√†y kh√¥ng ch·ªâ khi·∫øn n√≥ th·ª±c hi·ªán l·ªánh ƒë∆∞·ª£c m√† c√≤n c√≥ th·ªÉ *ghi nh·ªõ*.

![image.png](https://images.viblo.asia/e1556974-5ca8-4429-86c4-b6a1276c05a5.png)

Trong b√†i vi·∫øt n√†y ch√∫ng ta s·∫Ω l√†m ƒëi·ªÅu ƒë√≥. ƒê·ªãnh nghƒ©a c√¢u l·ªánh xu·∫•t ra m√†n h√¨nh `in` v√† c√¢u l·ªánh khai b√°o bi·∫øn `t·∫°o`.Ch√∫ng ta s·∫Ω th√™m c√°c bi·ªÉu th·ª©c ƒë·ªÉ truy c·∫≠p v√† g√°n cho c√°c bi·∫øn. Cu·ªëi c√πng ch√∫ng ta s·∫Ω tri·ªÉn khai tr·∫°ng th√°i trong ph·∫°m vi c·ª•c b·ªô.

# C√¢u l·ªánh (statements)
Ch√∫ng ta s·∫Ω m·ªü r·ªông b·ªô quy t·∫Øc c·ªßa ViL v·ªõi m·ªôt lo·∫°i quy t·∫Øc m·ªõi - statements, ch√∫ng kh√¥ng kh√°c bi·ªát qu√° nhi·ªÅu v·ªõi expression. B·∫Øt ƒë·∫ßu v·ªõi 2 lo·∫°i statements:
- C√¢u l·ªánh bi·ªÉu th·ª©c ***expression statements***: V·∫´n l√† m·ªôt bi·ªÉu th·ª©c chung nh∆∞ng ta ngƒÉn c√°ch n√≥ b·∫±ng d·∫•u `;` ·ªü cu·ªëi, tr√°nh c√°c side-effect gi·ªØa 2 bi·ªÉu th·ª©c kh√°c nhau nh∆∞ng ƒë·∫∑t c·∫°nh nhau g√¢y hi·ªÉu l·∫ßm. B·∫°n c√≥ th·ªÉ kh√¥ng nh·∫≠n th·∫•y ch√∫ng, nh∆∞ng b·∫°n v·∫´n s·ª≠ d·ª•ng ch√∫ng m·ªçi l√∫c trong C, Java v√† c√°c ng√¥n ng·ªØ kh√°c. B·∫•t c·ª© khi n√†o b·∫°n th·∫•y m·ªôt h√†m ho·∫∑c l·ªánh g·ªçi ph∆∞∆°ng th·ª©c ƒë∆∞·ª£c theo sau b·ªüi d·∫•u `;`, b·∫°n ƒëang khai b√°o m·ªôt c√¢u l·ªánh bi·ªÉu th·ª©c.
- C√¢u l·ªánh xu·∫•t ra m√†n h√¨nh ***print statements***: ƒë√°nh gi√° m·ªôt bi·ªÉu th·ª©c v√† hi·ªÉn th·ªã k·∫øt qu·∫£ ra m√†n h√¨nh cho ng∆∞·ªùi d√πng. h∆°i k√¨ l·∫° khi ƒë·ªÉ ph∆∞∆°ng th·ª©c in l√† m·ªôt c√¢u l·ªánh ri√™ng thay v√¨ m·ªôt h√†m g·ªçi, tuy nhi√™n ƒë·ªÉ th·ª±c hi·ªán ch·ª©c nƒÉng h√†m cho ng√¥n ng·ªØ ch√∫ng ta c·∫ßn r·∫•t nhi·ªÅu th·ª© ƒë·ªÉ tri·ªÉn khai m√† m√¨nh s·∫Ω ƒë√°nh ƒë·ªïi ƒëi·ªÅu ƒë√≥ ƒë·ªÉ ch√∫ng ta c√≥ th·ª© g√¨ ƒë√≥ ƒë·ªÉ ngh·ªãch ng·ª£m v·ªõi ViL trong l√∫c n√≥ ch∆∞a ho√†n thi·ªán.

M·ªôt quy t·∫Øc m·ªõi ƒë∆∞·ª£c th√™m v√†o v·∫≠y n√™n ch√∫ng ta c√≥ m·ªôt b·∫£ng quy t·∫Øc m·ªõi, v·ªõi vi·ªác th√™m statement cu·ªëi c√πng ta ƒë√£ ph√¢n t√≠ch to√†n b·ªô m√£ c·ªßa ViL ch·ª© kh√¥ng ch·ªâ m·ªôt bi·ªÉu th·ª©c ƒë∆°n gi·∫£n. B·ªô quy t·∫Øc m·ªõi nh∆∞ sau:
```js
program               => statement* EOF ;

statement             => expressionStatement
                      | printStatement ;

expressionStatement   => expression ";" ;
printStatement        => "xu·∫•t" expression ";" ;
```

Quy t·∫Øc m·ªõi ƒë·∫ßu ti√™n `program` ƒë·∫°i di·ªán cho c·∫£ ch∆∞∆°ng tr√¨nh v·ªõi t·∫≠p h·ª£p c√°c c√¢u l·ªánh li√™n ti·∫øp v√† k·∫øt th√∫c khi ch√∫ng ta ƒë·∫øn cu·ªëi file. Hi·ªán t·∫°i ch√∫ng ta c√≥ hai lo·∫°i c√¢u l·ªánh nh∆∞ ƒë√£ n√≥i b√™n tr√™n, b√¢y gi·ªù b∆∞·ªõc ti·∫øp theo l√† chuy·ªÉn t·ª´ c√°c quy t·∫Øc sang c√¢y c√∫ ph√°p v√† th·ª±c thi n√≥.


## C√¢y c√∫ ph√°p c·ªßa c√¢u l·ªánh
* Ch√∫ng ta kh√¥ng th·ªÉ s·ª≠ d·ª•ng l·∫°i l·ªõp ƒë·∫°i di·ªán c√¢y c√∫ ph√°p c·ªßa bi·ªÉu th·ª©c (expresssion) ƒë·ªÉ bi·ªÉu di·ªÖn c√¢u l·ªánh, nh∆∞ trong b·∫£ng quy t·∫Øc ph√©p c·ªông c√¢u l·ªánh hay tr·ª´ l√† v√¥ l√≠. ƒêi·ªÅu ƒë√≥ d·∫´n d·∫øn vi·ªác ta c·∫ßn ph·∫£i t·∫°o m·ªôt base class m·ªõi cho c√¢u l·ªánh. Nh∆∞ng ƒë·ª´ng lo, n√≥ kh√¥ng kh√°c bi·ªÉu th·ª©c l√† m·∫•y, ta ch·ªâ c·∫ßn ƒë·ªãnh nghƒ©a c√∫ ph√°p v√† ph·∫ßn code s·∫Ω do code gen ƒë·∫£m nhi·ªám.

Source: `lib/grammar/statement.dart`
```dart
import 'package:annotations/annotations.dart';
import 'package:vil/grammar/expression.dart';

part 'statement.g.dart';

@Ast([
  'PrintStmt : Expression expression',
  'ExprStmt  : Expression expression',
])
class _Statement {}
```

V√† ch·∫°y l·ªánh `dart run build_runner build`, k·∫øt qu·∫£ ta gen ƒë∆∞·ª£c file `statement.g.dart` nh∆∞ sau:
```dart
// GENERATED CODE - DO NOT MODIFY BY HAND

part of 'statement.dart';

// **************************************************************************
// AstGenerator
// **************************************************************************

abstract class StatementVisitor<T> {
  T visitPrintStmt(PrintStmt printStmt);
  T visitExprStmt(ExprStmt exprStmt);
}

abstract class Statement {
  T accept<T>(StatementVisitor<T> visitor);
}

class PrintStmt extends Statement {
  final Expression expression;
  PrintStmt(
    this.expression,
  );
  T accept<T>(StatementVisitor<T> visitor) {
    return visitor.visitPrintStmt(this);
  }
}

class ExprStmt extends Statement {
  final Expression expression;
  ExprStmt(
    this.expression,
  );
  T accept<T>(StatementVisitor<T> visitor) {
    return visitor.visitExprStmt(this);
  }
}
```

## Ph√¢n t√≠ch c√¢u l·ªánh
H√†m `parse` trong l·ªõp Parser gi·ªù ƒë√¢y s·∫Ω kh√¥ng c√≤n tr·∫£ v·ªÅ `Expression` n·ªØa m√† l√† m·ªôt lo·∫°t c√°c `Statement`:

Source: `lib/parser.dart`, S·ª≠a ƒë·ªïi h√†m `parse`
```dart
List<Statement>? parse() {
  try {
    List<Statement> statements = [];
    while (!_isAtEnd) {
      statements.add(_statement());
    }

    return statements;
  } on ParserError catch (_) {
    return null;
  }
}
```

ƒê·ª´ng qu√™n import `Statement` nh√©:

```dart
import 'package:vil/grammar/statement.dart';
```

H√†m `parse` kh√° d·ªÖ d√†ng chuy·ªÉn t·ª´ b·ªô quy t·∫Øc `program` sang. Thu th·∫≠p t·∫•t c·∫£ c√°c c√¢u l·ªánh cho ƒë·∫øn khi ƒë·∫øn cu·ªëi file.

### C√¢u l·ªánh chung
H√†m `_statement` gi·ªëng nh∆∞ h√†m `_expression` n√≥ "g√≥i" chung l·∫°i t·∫•t c·∫£ c√°c c√¢u l·ªánh tuy nhi√™n h∆°i kh√°c m·ªôt ch√∫t c√°c c√¢u l·ªánh c√≥ m·ª©c ƒë·ªô ∆∞u ti√™n ngang b·∫±ng nhau n√™n ch√∫ng c√πng xu·∫•t hi·ªán ·ªü trong h√†m `_statement` c√≤n bi·ªÉu th·ª©c ph·∫£i c√≥ s·ª± ∆∞u ti√™n tr∆∞·ªõc sau n√™n n√≥ ch·ªâ g√≥i l·∫°i bi·ªÉu th·ª©c m·ª©c ƒë·ªô ∆∞u ti√™n th·∫•p nh·∫•t.

Source: `lib/parser.dart`
```dart
Statement _statement() {
  if (_match([TokenType.kXuat])) {
    return _printStatement();
  }

  return _expressionStatement();
}
```

### C√¢u l·ªánh xu·∫•t
H√†m t·∫°o c√¢u l·ªánh xu·∫•t ra m√†n h√¨nh c·ª© √°p d·ª•ng c√¥ng th·ª©c m√† l√†m l√† xong :D
```dart
Statement _printStatement() {
  final expression = _expression();
  _consume(
      TokenType.semicolon, 'Thi·∫øu d·∫•u ";" sau c√¢u l·ªánh xu·∫•t ra m√†n h√¨nh.');

  return Print(expression);
}
```

### C√¢u l·ªánh bi·ªÉu th·ª©c
Nh∆∞ c√¥ng th·ª©c üòâ

```dart
Statement _expressionStatement() {
  final expression = _expression();
  _consume(TokenType.semicolon, 'Thi·∫øu d·∫•u ";" sau c√¢u l·ªánh.');

  return Expr(expression);
}
```

## Th·ª±c thi c√¢u l·ªánh
Tr√¨nh ph√¢n t√≠ch c√∫ ph√°p c·ªßa ch√∫ng ta hi·ªán c√≥ th·ªÉ t·∫°o ra c√°c c√¢y c√∫ ph√°p c√¢u l·ªánh, v√¨ v·∫≠y b∆∞·ªõc ti·∫øp theo v√† cu·ªëi c√πng l√† di·ªÖn gi·∫£i ch√∫ng. Gi·ªëng nh∆∞ trong c√°c bi·ªÉu th·ª©c, ch√∫ng ta s·ª≠ d·ª•ng visitor patterm, v√† v·ªõi m·ªôt base class m·ªõi ta c≈©ng ph·∫£i c√≥ m·ªôt Visitor ri√™ng c·ªßa n√≥ `StatementVisitor` ƒë·ªÉ th·ª±c thi.

Source: `lib/interpreter.dart`
```dart
class Interpreter
    implements ExpressionVisitor<dynamic>, StatementVisitor<void> {
...


  @override
  void visitExpr(Expr exprStmt) {
    // TODO: implement visitExpr
  }

  @override
  void visitPrint(Print printStmt) {
    // TODO: implement visitPrint
  }
}
```

C√¢u l·ªánh kh√¥ng tr·∫£ v·ªÅ g√¨ c·∫£ m√† n√≥ ch·ªâ th·ª±c thi n√™n generic type c·ªßa n√≥ l√† void.

### Th·ª±c thi c√¢u l·ªánh xu·∫•t
V·ªÅ c√¢u l·ªánh xu·∫•t ra m√†n h√¨nh ch·ªâ ƒë∆°n gi·∫£n l√† ƒë√°nh gi√° bi·ªÉu th·ª©c b√™n trong v√† qua h√†m `print` c·ªßa dart xu·∫•t ra m√†n h√¨nh, v·∫≠y l√† ho√†n th√†nh. ƒë·ªÉ ch·∫Øc ch·∫Øn ta ƒë∆∞a gi√° tr·ªã v√†o h√†m `_stringify` ƒë·ªÉ x·ª≠ l√≠ sang chu√¥ƒ© t∆∞∆°ng ·ª©ng gi√° tr·ªã.

```dart
@override
void visitPrint(Print printStmt) {
  final value = _evaluate(printStmt.expression);
  print(_stringify(value));
}
```

ƒê·∫ßu v√†o c·ªßa `Interpreter` ƒë√£ thay ƒë·ªïi n√≥ l√† m·ªôt `List<Statement>` thay v√¨ `Expression` khi tr∆∞·ªõc, s·ª≠a l·∫°i h√†m `interpret` m·ªôt ch√∫t:

Source: `lib/interpreter.dart`
```dart
void interpret(List<Statement> statements) {
  try {
    for (final statement in statements) {
      _execute(statement);
    }
  } on RuntimeError catch (error) {
    Vil.runtimeError(error);
  }
}
```

H√†m `_execute` truy·ªÅn `Interpreter` v√†o `statement` ƒë·ªÉ t·ª± ƒë√°nh gi√°.

Source: `lib/interpreter.dart`, b√™n d∆∞·ªõi `interpret`
```dart
void _execute(Statement statement) {
  statement.accept(this);
}
```

S·ª≠a l·∫°i h√†m `run` trong l·ªõp g·ªëc `Vil`.

Source: `lib/vil.dart`, h√†m `run`
```dart
static void run(String source) {
  Scanner scanning = Scanner(source);
  List<Token> tokens = scanning.scan();

  Parser parser = Parser(tokens);
  final statements = parser.parse();
  if (statements != null) {
    interpreter.interpret(statements);
  }
}
```

Tuy·ªát! Ch√∫ng ta ƒë√£ c√≥ kh·∫£ nƒÉng th·ª±c hi·ªán ƒë∆∞·ª£c l·ªánh xu·∫•t ra m√†n h√¨nh.
```js
.../crafting-interpreters/vil/vil$ dart run lib/vil.dart
lib/vil.dart: Warning: Interpreting this as package URI, 'package:vil/vil.dart'.
> xu·∫•t "Ch√†o th·∫ø gi·ªõi";
Ch√†o th·∫ø gi·ªõi
> xu·∫•t 3 * 4 + 5; 
17
> xu·∫•t ƒë√∫ng;
ƒë√∫ng
> xu·∫•t r·ªóng;
r·ªóng
```

N√≥ g·∫ßn gi·ªëng nh∆∞ m·ªôt ch∆∞∆°ng tr√¨nh th·ª±c s·ª±! ƒê·ª´ng qu√™n d·∫•u `;` c·ªßa b·∫°n nh√© üòÖ

# Bi·∫øn to√†n c·ª•c
B√¢y gi·ªù ch√∫ng ta ƒë√£ c√≥ c√°c c√¢u l·ªánh, ch√∫ng ta c√≥ th·ªÉ b·∫Øt ƒë·∫ßu l√†m vi·ªác v·ªÅ tr·∫°ng th√°i c·ªßa ch∆∞∆°ng tr√¨nh. Tr∆∞·ªõc khi ƒëi v√†o t·∫•t c·∫£ s·ª± ph·ª©c t·∫°p v·ªÅ tr·∫°ng th√°i c·ª•c b·ªô, ch√∫ng ta h√£y b·∫Øt ƒë·∫ßu v·ªõi lo·∫°i l∆∞u bi·∫øn ƒë∆°n gi·∫£n nh·∫•t - bi·∫øn to√†n c·ª•c. Ch√∫ng ta c·∫ßn hai c√∫ ph√°p m∆°i ƒë·ªÉ th·ª±c hi·ªán ƒëi·ªÅu n√†y.
1. C√∫ ph√°p **khai b√°o** v√† **kh·ªüi t·∫°o** bi·∫øn. C√¢u l·ªánh n√†y th·ª±c hi·ªán hai vi·ªác kh·ªüi t·∫°o bi·∫øn t√™n `hoa`, sau ƒë√≥ g√°n gi√° tr·ªã `"c√∫c d·∫°i"` cho n√≥.
```dart
t·∫°o hoa = "c√∫c d·∫°i";
```
2. Sau khi th·ª±c hi·ªán th√†nh c√¥ng c√¢u l·ªánh tr√™n, truy c·∫≠p v√†o t√™n bi·∫øn `hoa` l·∫•y gi√° tr·ªã `"c√∫c d·∫°i"` ra v√† xu·∫•t ra m√†n h√¨nh.
```dart
xu·∫•t hoa; // c√∫c d·∫°i
```

Sau ƒë√≥, ch√∫ng t√¥i s·∫Ω th√™m ph√©p g√°n v√† kh·ªëi l·ªánh, nh∆∞ng hi·ªán t·∫°i nh∆∞ v·∫≠y l√† ƒë·ªß ƒë·ªÉ tri·ªÉn khai.

## C√∫ ph√°p t·∫°o bi·∫øn
Nh∆∞ b√™n tr√™n ch√∫ng ta ƒë√£ ƒë·ªãnh nghƒ©a n√≥ s·∫Ω c√≥ d·∫°ng
```dart
t·∫°o hoa = "c√∫c d·∫°i";
```
Quy t·∫Øc t∆∞∆°ng ƒë∆∞∆°ng nh∆∞ sau
```js
variableDecl => "t·∫°o" IDENTIFIER ("=" expression)? ";" ;
```


Quy t·∫Øc m·ªõi c·ªßa ch√∫ng ta nh∆∞ sau:
```js
program        => statement* EOF ;

statement      => expressionStatement
               |  printStatement
               |  variableDecl ;
```

Nh∆∞ng ƒë·ªÉ thu·∫≠n ti·ªán v·ªÅ vi·ªác ƒë·ªãnh nghƒ©a c√°c quy t·∫Øc m·ªõi v·ªÅ khai b√°o h√†m, khai b√°o l·ªõp ·ªü trong c√°c b√†i vi·∫øt sau ch√∫ng ta s·∫Ω t√°ch c√¢u l·ªánh t·∫°o bi·∫øn ra m·ªôt l·ªõp tr·ª´u t∆∞·ª£ng kh√°c `declaration`, b·∫£n ch·∫•t n√≥ v·∫´n l√† `statement` nh∆∞ng v·ªõi ƒë·ªô ∆∞u ti√™n th·∫•p h∆°n m·ªôt ch√∫t.

```js
program        => declaration* EOF ;

declaration    => variableDecl
               |  statement ; 

statement      => expressionStatement
               |  printStatement ;
```

Ch√∫ng ta c·∫ßn ph·∫£i x√°c ƒë·ªãnh ƒë·ªãnh danh `IDENTIFIER` m·ªôt c√°i t√™n ƒë·∫°i di·ªán cho gi√° tr·ªã n√†o ƒë√≥, ƒë·ªÉ truy c·∫≠p bi·∫øn ta c√≥ bi·ªÉu th·ª©c `primary` m·ªõi nh∆∞ sau.
```dart
primary        => s·ªë | chu·ªói
               |  "ƒë√∫ng" | "sai" | "r·ªóng"
               |  "(" expression ")"
               |  IDENTIFIER ;
```

Ch√∫ng ta ƒë√£ l√†m r√µ b·ªô quy t·∫Øc c·∫ßn thi·∫øt, b√¢y gi·ªù tri·ªÉn khai ph·∫ßn code th√¥i, ƒë·ªãnh nghƒ©a l·ªõp `VariableDeclaration` m·ªõi nh·∫≠n v√†o token `name` t√™n c·ªßa bi·∫øn v√† `value` gi√° tr·ªã kh·ªüi t·∫°o c·ªßa bi·∫øn ƒë√≥ c√≥ th·ªÉ c√≥ ho·∫∑c kh√¥ng.

Source: `lib/grammar/statement.dart`, b√™n tr√™n `_Statement`
```dart
@Ast([
  'Print        : Expression expression',
  'Expr         : Expression expression',
  'VariableDecl : Token name, Expression? value',
])
```

Ch√∫ng ta c≈©ng c·∫ßn th√™m m·ªôt bi·ªÉu th·ª©c ƒë·ªÉ l∆∞u tr·ªØ t√™n bi·∫øn.

Source: `lib/grammar/expression.dart`, b√™n tr√™n `_Expression`
```dart
@Ast([
  "Binary   : Expression left, Token operator, Expression right",
  "Grouping : Expression expression",
  "Literal  : dynamic value",
  "Unary    : Token operator, Expression right",
  "Variable : Token name"
])
```

Ch·∫°y l·ªánh `dart run build_runner build` l√† xong.
### Ph√¢n t√≠ch c√∫ ph√°p ph√©p t·∫°o bi·∫øn
B√¢y gi·ªù quy t·∫Øc ƒë·∫ßu ti√™n l√† `_declaration` n√™n ch√∫ng ta c·∫ßn ch·ªânh s·ª≠a m·ªôt ch√∫t ·ªü h√†m `parse` trong  `Parser`

Source: `lib/parser.dart`, h√†m `parse`
```dart
List<Statement>? parse() {
  try {
    List<Statement> statements = [];
    while (!_isAtEnd) {
      statements.add(_declaration()); // Thay ƒë·ªïi t·ª´ `_statement` => `_declaration`
    }

    return statements;
  } on ParserError catch (_) {
    return null;
  }
}
```

Ch√∫ng ta c√≥ m·ªôt h√†m m·ªõi nh∆∞ sau:
```dart
Statement _declaration() {
  if (_match([TokenType.kTao])) {
    return _variableDeclaration();
  }

  return _statement();
}

Statement _variableDeclaration() {
  final token = _consume(TokenType.identifier, 'C·∫ßn ƒë·ªãnh nghƒ©a t√™n bi·∫øn.');

  Expression? initializer;
  if (_match([TokenType.equal])) {
    initializer = _expression();
  }

  _consume(TokenType.semicolon, 'Thi·∫øu d·∫•u ";" sau c√¢u l·ªánh.');
  return VariableDecl(token, initializer);
}
```

Th√™m m·ªôt d√≤ng ƒë·ªÉ ph√¢n t√≠ch bi·ªÉu th·ª©c `Variable` m·ªõi ·ªü h√†m `_primary`

```dart
Expression _primary() {
  
  ...
  
  if (_match([TokenType.identifier])) {
    return Variable(_previous());
  }

  throw _error(_peek(), 'Token ch∆∞a c√≥ trong b·∫£ng quy t·∫Øc.');
}
```

T·∫•t c·∫£ vi·ªác n√†y cung c·∫•p cho ch√∫ng ta ph·∫ßn ph√¢n t√≠ch ho·∫°t ƒë·ªông ƒë·ªÉ khai b√°o v√† s·ª≠ d·ª•ng c√°c bi·∫øn. T·∫•t c·∫£ nh·ªØng g√¨ c√≤n l·∫°i l√† ƒë∆∞a k·∫øt qu·∫£ v√†o tr√¨nh th√¥ng d·ªãch. Tr∆∞·ªõc khi ƒë·∫°t ƒë∆∞·ª£c ƒëi·ªÅu ƒë√≥, ch√∫ng ta c·∫ßn n√≥i v·ªÅ n∆°i c√°c bi·∫øn "s·ªëng" trong b·ªô nh·ªõ.

# M√¥i tr∆∞·ªùng l∆∞u tr·ªØ
C√°c r√†ng bu·ªôc li√™n k·∫øt c√°c bi·∫øn v·ªõi gi√° tr·ªã c·∫ßn ƒë∆∞·ª£c l∆∞u tr·ªØ ·ªü ƒë√¢u ƒë√≥. K·ªÉ t·ª´ khi ng∆∞·ªùi Lisp ph√°t minh ra d·∫•u ngo·∫∑c ƒë∆°n, c·∫•u tr√∫c d·ªØ li·ªáu n√†y ƒë√£ ƒë∆∞·ª£c g·ªçi l√† **m√¥i tr∆∞·ªùng**.

Source: `https://craftinginterpreters.com`
![image.png](https://images.viblo.asia/e72107c2-f8d8-4029-a108-e4f37903a1b1.png)

N√≥ c√≥ th·ªÉ hi·ªÉu ƒë∆°n gi·∫£n l√† m·ªôt `Map` v·ªõi key l√† t√™n ƒë·ªãnh danh c·ªßa bi·∫øn ƒë√≥ v√† value l√† gi√° tr·ªã c·ªßa n√≥, ch√∫ng ta c√≥ th·ªÉ khai b√°o tr·ª±c ti·∫øp theo d·∫°ng map v√†o tr√¨nh th√¥ng d·ªãch nh∆∞ng v√¨ t√≠nh ƒë√≥ng g√≥i ta s·∫Ω ƒë∆∞a n√≥ v√†o m·ªôt l·ªõp m·ªõi `Environment` ƒë·ªÉ ti·ªán tri·ªÉn khai.

Source: `lib/environment.dart`, t·∫°o file v√† t·∫°o l·ªõp `Environment`
```dart
import 'package:vil/interpreter.dart';
import 'package:vil/token.dart';

class Environment {
  Map<String, dynamic> _values = {};
}
```

Ch√∫ng ta s·ª≠ d·ª•ng `String` thay v√¨ `Token` v√¨ `Token` v√¨ `Token` ch·ª©a c·∫£ **v·ªã tr√≠** c·ªßa t√™n bi·∫øn, ch√∫ng ta kh√¥ng c·∫ßn ƒë·∫øn ƒëi·ªÅu ƒë√≥ n√™n thay v√¨ th·∫ø s·ª≠ d·ª•ng lu√¥n t√™n bi·∫øn ƒë·ªÉ l√†m key.

M√¥i tr∆∞·ªùng c·∫ßn hai ph∆∞∆°ng th·ª©c ƒë·ªÉ **khai b√°o** v√† **truy c·∫≠p** bi·∫øn nh∆∞ sau.

Source: `lib/environment.dart`, ph∆∞∆°ng th·ª©c khai b√°o bi·∫øn (`define`)
```dart
void define(String name, dynamic value) {
  _values[name] = value;
}
```

Kh√¥ng h·∫≥n l√† c·ªë √Ω, nh∆∞ng ch√∫ng ta ƒë√£ ƒë∆∞a ra m·ªôt s·ª± l·ª±a ch·ªçn trong c√°ch c√°ch ti·∫øp c·∫≠n bi·∫øn. Khi ta th√™m key v√†o map `_values` v√† kh√¥ng ki·ªÉm tra xem n√≥ ƒë√£ c√≥ s·∫µn hay ch∆∞a. ƒêi·ªÅu ƒë√≥ c√≥ nghƒ©a l√† ch∆∞∆°ng tr√¨nh n√†y ho·∫°t ƒë·ªông, n√≥ kh√¥ng ph√¢n bi·ªát r√µ r√†ng bi·∫øn ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o hay ch∆∞a m√† ch·ªâ thay ƒë·ªïi gi√° tr·ªã c·ªßa bi·∫øn.
```js
t·∫°o a = "before";
xu·∫•t a; // "before".
t·∫°o a = "after";
xu·∫•t a; // "after".
```


Source: `lib/environment.dart`, ph∆∞∆°ng th·ª©c truy c·∫≠p bi·∫øn (`define`)
```dart
dynamic get(Token name) {
  if (_values.containsKey(name.lexeme)) {
    return _values[name.lexeme];
  }
  
  throw RuntimeError(
    token: name,
    message: 'Bi·∫øn "${name.lexeme}" ch∆∞a ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a.',
  );
}
```

Khi truy c·∫≠p n·∫øu kh√¥ng t·ªìn t·∫°i ch√∫ng ta n√©m tr·∫£ l·∫°i m·ªôt l·ªói runtime.

## Tri·ªÉn khai bi·∫øn to√†n c·ª•c
T·∫°o m·ªôt instance c·ªßa `Environment` trong l·ªõp `Interpreter`

Source: `lib/interpreter.dart`
```dart
class Interpreter
    implements ExpressionVisitor<dynamic>, StatementVisitor<void> {
  Environment _environment = Environment();

  ...
}
```

Ch√∫ng ta l∆∞u tr·ªØ bi·∫øn trong m√¥i tr∆∞·ªùng ƒë·∫øn khi n√†o m√† `Interpreter` v·∫´n t·ªìn t·∫°i v√† ƒëang ch·∫°y. 

·ªû b√™n tr√™n ch√∫ng ta ƒë·ªãnh nghƒ©a hai c√∫ ph√°p m·ªõi: bi·ªÉu th·ª©c `Variable` v√† c√¢u l·ªánh `VariableDecl`, b√¢y gi·ªù h√£y x·ª≠ l√≠ n√≥.

Source: `lib/interpreter.dart`, h√†m x·ª≠ l√≠ `visitVariableDecl`
```dart
@override
void visitVariableDecl(VariableDecl variableDeclStmt) {
  dynamic value = null;
  if (variableDeclStmt.value != null) {
    value = _evaluate(variableDeclStmt.value!);
  }
  _environment.define(variableDeclStmt.name.lexeme, value);
}
```

Source: `lib/interpreter.dart`, h√†m x·ª≠ l√≠ `visitVariable`
```dart
@override
dynamic visitVariable(Variable variable) {
  return _environment.get(variable.name);
}
```

B√¢y gi·ªù ch√∫ng ta ho√†n to√†n c√≥ th·ªÉ ch·∫°y c√¢u l·ªánh sau
```js
t·∫°o a = 1;
t·∫°o b = 2;
xu·∫•t a + b;
```

V·ªõi m·ªôt ch√∫t code v·ªÅ ph·∫ßn `Environment` ng√¥n ng·ªØ ch√∫ng ta ƒë√£ c√≥ th·ªÉ **nh·ªõ** ƒë∆∞·ª£c d·ªØ li·ªáu.

# Ph√©p g√°n
Ch√∫ng ta ƒë√£ c√≥ th·ªÉ t·∫°o ƒë∆∞·ª£c bi·∫øn, ƒëi·ªÅu ti·∫øp theo l√† thay ƒë·ªïi bi·∫øn ƒë√≥ theo √Ω mu·ªën c·ªßa m√¨nh. c√∫ ph√°p m·ªõi c·ªßa ch√∫ng ta nh∆∞ sau.

```js
expression => assignment ;
assignment => IDENTIFIER "=" expression ";"
           |  equality ;
```

Quy tr√¨nh th√™m m·ªôt c√∫ ph√°p m·ªõi r·∫•t ƒë∆°n gi·∫£n nh∆∞ m·ªçi l·∫ßn tr∆∞·ªõc.

Source: `lib/grammar/expression.dart`
```dart
@Ast([
  "Binary   : Expression left, Token operator, Expression right",
  "Grouping : Expression expression",
  "Literal  : dynamic value",
  "Unary    : Token operator, Expression right",
  "Variable : Token name",
  "Assign   : Token name, Expression value" // Th√™m d√≤ng n√†y
])
```

## C√∫ ph√°p ph√©p g√°n
Ti·∫øp t·ª•c thay ƒë·ªïi `Parser` theo quy t·∫Øc m·ªõi.

Source: `lib/parser.dart`
```dart
Expression _expression() {
  return _assignment();
}
```

Source: `lib/parser.dart`, h√†m `_assignment` 
```dart
Expression _assignment() {
  final expression = _equality();

  if (_match([TokenType.equal])) {
    final equals = _previous();
    final value = _assignment();

    if (expression is Variable) {
      return Assign(expression.name, value);
    }

    _error(equals, 'Kh√¥ng th·ªÉ g√°n gi√° tr·ªã n·∫øu kh√¥ng ƒë√≥ kh√¥ng l√† bi·∫øn.');
  }

  return expression;
}
```

## Th·ª±c thi ph√©p g√°n

Tri·ªÉn khai visitor cho ph√©p g√°n trong `Interpreter`.

Source: `lib/interpreter.dart`, h√†m `visitAssign`
```dart
@override
dynamic visitAssign(Assign assign) {
  final value = _evaluate(assign.value);
  _environment.assign(assign.name, value);
  return value;
}
```

Th√™m ph∆∞∆°ng th·ª©c g√°n trong `Environment`

Source: `lib/environment.dart`
```dart
void assign(Token name, dynamic value) {
  if (_values.containsKey(name.lexeme)) {
    _values[name.lexeme] = value;
    return;
  }

  throw RuntimeError(
    token: name,
    message: 'Bi·∫øn "${name.lexeme}" ch∆∞a ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a.',
  );
}
```

Xong !!! Ch√∫ng ta ƒë√£ ho√†n th√†nh ph√©p g√°n cho bi·∫øn to√†n c·ª•c, ph·∫ßn ti·∫øp theo c√πng th·ª±c hi·ªán ph·∫°m vi h·∫πp h∆°n c·ªßa bi·∫øn khi n√≥ ·ªü trong m·ªôt scope nh·ªè h∆°n nh∆∞ ·ªü trong h√†m hay m·ªôt c√¢u l·ªánh ƒëi·ªÅu ki·ªán.

# Ph·∫°m vi
**Ph·∫°m vi** x√°c ƒë·ªãnh m·ªôt khu v·ª±c n∆°i t√™n √°nh x·∫° t·ªõi m·ªôt gi√° tr·ªã nh·∫•t ƒë·ªãnh. Nhi·ªÅu ph·∫°m vi cho ph√©p **c√πng m·ªôt t√™n** ƒë·ªÉ ch·ªâ nh·ªØng th·ª© kh√°c nhau trong c√°c **ng·ªØ c·∫£nh kh√°c nhau**. V√≠ d·ª• nh∆∞:
```js
{
  t·∫°o a = "first";
  xu·∫•t a; // "first".
}

{
  t·∫°o a = "second";
  xu·∫•t a; // "second".
}
```

ƒêo·∫°n code tr√™n ch·ª©a hai kh·ªëi code kh√°c nhau c√πng ƒë·ªãnh nghƒ©a bi·∫øn `a` nh∆∞ng √°nh x·∫° ƒë·∫øn c√°c gi√° tr·ªã kh√°c nhau.

![image.png](https://images.viblo.asia/4466f6b1-a77b-4f9d-9959-964aa6daf3e8.png)

Bi·∫øn ƒë∆∞·ª£c t·∫°o ch·ªâ truy c·∫≠p ƒë∆∞·ª£c trong ph·∫°m vi c·ªßa n√≥. sau khi ra kh·ªèi scope, bi·∫øn s·∫Ω ƒë∆∞·ª£c gi·∫£i ph√≥ng b·ªô nh·ªõ.
```dart
{
  t·∫°o a = "in block";
}
xu·∫•t a; // L·ªói bi·∫øn a ƒë√£ b·ªã h·ªßy.
```

## S·ª± l·ªìng nhau c·ªßa kh·ªëi l·ªánh

S·∫Ω th·∫ø n√†o n·∫øu ta g·ªçi h√†m xu·∫•t trong m·ªôt kh·ªëi ri√™ng nh∆∞ th·∫ø n√†y?
```js
t·∫°o globalScope = "B√™n ngo√†i";

{
  t·∫°o local = "B√™n trong";
  {
      xu·∫•t global + local;
  }
}
```

ViL t√¨m ki·∫øm hai bi·∫øn `globalScope` v√† `localScope` trong scope hi·ªán t·∫°i nh∆∞ng kh√¥ng c√≥, ti·∫øp theo n√≥ s·∫Ω t√¨m ki·∫øm ·ªü ph·∫°m vi r·ªông h∆°n, scope bao ngo√†i n√≥. A !!! t√¨m th·∫•y bi·∫øn `localScope` r·ªìi, l·∫•y gi√° tr·ªã c·ªßa n√≥ v√† ti·∫øp t·ª•c t√¨m bi·∫øn `globalScope` nh∆∞ng trong scope n√†y v·∫´n kh√¥ng c√≥, ti·∫øp t·ª•c t√¨m r·ªông ra scope l·ªõn h∆°n ta th·∫•y `globalScope` ƒë√£ ƒë∆∞·ª£c khai b√°o l·∫•y gi√° tr·ªã v√† xu·∫•t ph√©p c·ªông chu·ªói ra m√†n h√¨nh.

ƒê·ªÉ th·ª±c hi·ªán ƒë∆∞·ª£c h√†nh vi n√†y s·ª≠a l·ªõp `Environment` th√™m cho n√≥ m·ªôt m√¥i tr∆∞·ªùng "cha" bao quanh m√¥i tr∆∞·ªùng hi·ªán t·∫°i.

Source: `lib/environment.dart`
```dart
class Environment {
  Environment([this.parent = null]);

  final Environment? parent;
  ...
}
```

H√†m truy c·∫≠p v√† h√†m g√°n ch√∫ng ta s·ª≠a l·∫°i ki·ªÉm tra bi·∫øn c·∫ßn truy c·∫≠p ho·∫∑c ch·ªânh s·ª≠a c·∫£ ·ªü trong m√¥i tr∆∞·ªùng `parent`

Source: `lib/environment.dart`, h√†m `get`
```dart
dynamic get(Token name) {
  if (_values.containsKey(name.lexeme)) {
    return _values[name.lexeme];
  }

  if (parent != null) return parent!.get(name);

  throw RuntimeError(
    token: name,
    message: 'Bi·∫øn "${name.lexeme}" ch∆∞a ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a.',
  );
}

void assign(Token name, dynamic value) {
  if (_values.containsKey(name.lexeme)) {
    _values[name.lexeme] = value;
    return;
  }
  
  if (parent != null) {
    parent!.assign(name, value);
    return;
  }

  throw RuntimeError(
    token: name,
    message: 'Bi·∫øn "${name.lexeme}" ch∆∞a ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a.',
  );
}
```

## C√∫ ph√°p v√† th·ª±c thi kh·ªëi l·ªánh
V·ªõi l·ªõp `Environment` m·ªõi ch√∫ng ta ho√†n to√†n c√≥ th·ªÉ tri·ªÉn khai kh·ªëi l·ªánh. Quy t·∫Øc nh∆∞ sau:
```js
statement => printStatement
          |  expressionStatement
          |  block ;

block     => "{" declaration* "}" ;
```

Khai b√°o quy t·∫Øc m·ªõi v√† ch·∫°y `dart run build_runner build`

Source: `lib/grammar/expression.dart`
```dart
@Ast([
  'Print        : Expression expression',
  'Expr         : Expression expression',
  'VariableDecl : Token name, Expression? value',
  'Block        : List<Statement> statements',
])
```

Thay ƒë·ªïi `Parser`, b·∫Øt c√∫ ph√°p c·ªßa khai b√°o kh·ªëi l·ªánh.

Source: `lib/parser.dart`
```dart
Statement _statement() {
  if (_match([TokenType.kXuat])) {
    return _printStatement();
  }
  if (_match([TokenType.leftBrace])) {
    return _blockStatement();
  }

  return _expressionStatement();
}

Statement _blockStatement() {
  final statements = <Statement>[];

  while (!_check(TokenType.rightBrace) && !_isAtEnd) {
    statements.add(_declaration());
  }
  _consume(TokenType.rightBrace, 'Thi·∫øu d·∫•u "}" sau kh·ªëi l·ªánh.');

  return Block(statements);
}
```

Cu·ªëi c√πng l√† th·ª±c thi kh·ªëi code tri·ªÉn khai visitor c·ªßa kh·ªëi l·ªánh.

Source: `lib/interpreter.dart`
```dart
@override
void visitBlock(Block block) {
  Environment blockEnv = Environment(_environment);
  _environment = blockEnv;

  for (final statement in block.statements) {
    _execute(statement);
  }

  _environment = _environment.parent!;
}
```

HO√ÄN TH√ÄNH!!! H√£y th·ª≠ ngay ƒëo·∫°n code sau n·∫øu b·∫°n th·ª±c hi·ªán ƒë√∫ng nh∆∞ m√¨nh s·∫Ω c√≥ k·∫øt qu·∫£ nh∆∞ b√™n d∆∞·ªõi:
```js
{
  t·∫°o a = " Scope: 1 ";
  t·∫°o b = " Scope: 1 ";
  t·∫°o c = " Scope: 1 ";
  {
      t·∫°o b = " Scope: 2 ";
      t·∫°o c = " Scope: 2 ";
      {
          t·∫°o a = " Scope: 3 ";
          xu·∫•t a + b + c;
      }
      xu·∫•t a + b + c;
  }
  xu·∫•t a + b + c;
}
```
K·∫øt qu·∫£
```dart
 Scope: 3  Scope: 2  Scope: 2 
 Scope: 1  Scope: 2  Scope: 2 
 Scope: 1  Scope: 1  Scope: 1 
```

# T·ªïng k·∫øt
B√†i vi·∫øt n√†y ch√∫ng ta ƒë√£ th·ª±c hi√™n ƒë∆∞·ª£c 3 th·ª©:
- Ng√¥n ng·ªØ ViL ƒë√£ l∆∞u tr·ªØ ƒë∆∞·ª£c tr·∫°ng th√°i
- T·∫°o ra bi·∫øn v√† truy c·∫≠p c≈©ng nh∆∞ s·ª≠a gi√° tr·ªã c·ªßa n√≥ ƒë∆∞·ª£c
- ƒê·ªãnh nghƒ©a ph·∫°m vi truy c·∫≠p c·ªßa bi·∫øn, ti·ªÅn ƒë·ªÅ ƒë·ªÉ th·ª±c hi·ªán c√°c c√¢u l·ªánh ƒëi·ªÅu ki·ªán v√† v√≤ng l·∫∑p, th·ª© m√† ch√∫ng ta tri·ªÉn khai ·ªü b√†i vi·∫øt sau

# M√£ ngu·ªìn
B·∫°n c√≥ th·ªÉ theo d√µi m√£ ngu·ªìn t·ª´ng b√†i vi·∫øt t·∫°i ƒë√¢y. ƒê·ª´ng ng·∫°i ƒë·ªÉ l·∫°i cho m√¨nh m·ªôt sao nh√© üòç

ViL : https://github.com/definev/vil